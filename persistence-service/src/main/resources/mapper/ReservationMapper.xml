<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edrs.persistence.mapper.ReservationMapper">

    <resultMap id="ReservationResultMap" type="com.edrs.persistence.entity.Reservation">
        <id property="confirmationNumber" column="confirmation_number"/>
        <result property="userId" column="user_id"/>
        <result property="reservationDate" column="reservation_date"/>
        <result property="status" column="status"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <insert id="insert" parameterType="com.edrs.persistence.entity.Reservation">
        INSERT INTO reservations (confirmation_number, user_id, reservation_date, status, created_at, updated_at)
        VALUES (#{confirmationNumber}, #{userId}, #{reservationDate}, #{status}, 
                COALESCE(#{createdAt}, CURRENT_TIMESTAMP), 
                COALESCE(#{updatedAt}, CURRENT_TIMESTAMP))
    </insert>

    <select id="findByConfirmationNumber" parameterType="string" resultMap="ReservationResultMap">
        SELECT confirmation_number, user_id, reservation_date, status, created_at, updated_at
        FROM reservations
        WHERE confirmation_number = #{confirmationNumber}
    </select>

    <update id="update" parameterType="com.edrs.persistence.entity.Reservation">
        UPDATE reservations
        SET user_id = #{userId},
            reservation_date = #{reservationDate},
            status = #{status},
            updated_at = CURRENT_TIMESTAMP
        WHERE confirmation_number = #{confirmationNumber}
    </update>

    <select id="countConfirmedReservationsForItemOnDate" resultType="long">
        SELECT COUNT(DISTINCT r.confirmation_number)
        FROM reservations r
        INNER JOIN reservation_items ri ON r.confirmation_number = ri.confirmation_number
        WHERE ri.inventory_item_id = #{itemId}
          AND r.reservation_date = #{reservationDate}
          AND r.status = 'CONFIRMED'
    </select>

    <select id="findConfirmedReservationsForItemOnDate" resultMap="ReservationResultMap">
        SELECT DISTINCT r.confirmation_number, r.user_id, r.reservation_date, r.status, r.created_at, r.updated_at
        FROM reservations r
        INNER JOIN reservation_items ri ON r.confirmation_number = ri.confirmation_number
        WHERE ri.inventory_item_id = #{itemId}
          AND r.reservation_date = #{reservationDate}
          AND r.status = 'CONFIRMED'
    </select>

    <insert id="insertReservationItem">
        INSERT INTO reservation_items (confirmation_number, inventory_item_id)
        VALUES (#{confirmationNumber}, #{inventoryItemId})
    </insert>

    <select id="findReservationItemIds" parameterType="string" resultType="string">
        SELECT inventory_item_id
        FROM reservation_items
        WHERE confirmation_number = #{confirmationNumber}
        ORDER BY inventory_item_id
    </select>

    <delete id="deleteReservationItems" parameterType="string">
        DELETE FROM reservation_items
        WHERE confirmation_number = #{confirmationNumber}
    </delete>

</mapper>
