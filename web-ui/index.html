<!DOCTYPE html>
<html lang="en" ng-app="edrsApp">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDRS - Equipment & Device Reservation System</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- AngularJS -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.3/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.3/angular-route.min.js"></script>
    
    <style>
        body {
            background-color: #f8f9fa;
        }
        .navbar-brand {
            font-weight: 600;
        }
        .card {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: none;
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #0d6efd;
            color: white;
            font-weight: 500;
        }
        .btn-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .btn-primary:hover {
            background-color: #0b5ed7;
            border-color: #0a58ca;
        }
        .login-container {
            max-width: 400px;
            margin: 100px auto;
        }
        .status-badge {
            font-size: 0.85em;
            padding: 0.35em 0.65em;
        }
        .status-pending {
            background-color: #ffc107;
            color: #000;
        }
        .status-confirmed {
            background-color: #198754;
            color: #fff;
        }
        .status-cancelled {
            background-color: #dc3545;
            color: #fff;
        }
        .table-responsive {
            border-radius: 0.375rem;
        }
        .alert {
            border-radius: 0.375rem;
        }
        .form-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        .reservation-item {
            background-color: #f8f9fa;
            padding: 0.5rem;
            margin: 0.25rem 0;
            border-radius: 0.25rem;
        }
    </style>
</head>
<body>
    <div ng-controller="AppController as app">
        <!-- Navigation Bar -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary" ng-if="app.isLoggedIn()">
            <div class="container-fluid">
                <a class="navbar-brand" href="#/">
                    <i class="bi bi-calendar-check"></i> EDRS
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="#/reservations/new" ng-class="{'active': app.currentView === 'new-reservation'}">
                                <i class="bi bi-plus-circle"></i> New Reservation
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#/reservations" ng-class="{'active': app.currentView === 'my-reservations'}">
                                <i class="bi bi-list-ul"></i> My Reservations
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#/inventory" ng-class="{'active': app.currentView === 'inventory'}">
                                <i class="bi bi-box-seam"></i> Inventory
                            </a>
                        </li>
                        <li class="nav-item" ng-if="app.isAdmin()">
                            <a class="nav-link" href="#/admin/reservations" ng-class="{'active': app.currentView === 'admin-reservations'}">
                                <i class="bi bi-clipboard-data"></i> All Reservations
                            </a>
                        </li>
                        <li class="nav-item" ng-if="app.isAdmin()">
                            <a class="nav-link" href="#/admin/inventory/add" ng-class="{'active': app.currentView === 'admin-add-inventory'}">
                                <i class="bi bi-plus-square"></i> Add Inventory
                            </a>
                        </li>
                    </ul>
                    <ul class="navbar-nav">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="bi bi-person-circle"></i> {{app.currentUser}}
                                <span ng-if="app.isAdmin()" class="badge bg-warning text-dark ms-1">Admin</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" ng-click="app.logout()"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container-fluid mt-4" ng-view></div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        var app = angular.module('edrsApp', ['ngRoute']);

        // Configuration
        app.constant('API_CONFIG', {
            reservationService: 'http://localhost:8080',
            inventoryService: 'http://localhost:8081'
        });

        // App Controller
        app.controller('AppController', ['$scope', '$location', 'AuthService', function($scope, $location, AuthService) {
            var vm = this;
            
            vm.currentUser = AuthService.getCurrentUser();
            vm.isAdmin = function() {
                return AuthService.isAdmin();
            };
            vm.isLoggedIn = function() {
                return AuthService.isLoggedIn();
            };
            vm.logout = function() {
                AuthService.logout();
                $location.path('/login');
            };
            
            $scope.$on('$routeChangeSuccess', function(event, current) {
                if (current && current.$$route) {
                    vm.currentView = current.$$route.viewName;
                }
            });
        }]);

        // Auth Service
        app.service('AuthService', [function() {
            var currentUser = null;
            var isAdminUser = false;
            
            this.login = function(username) {
                currentUser = username;
                // Simple admin check - users starting with "admin" are admins
                isAdminUser = username.toLowerCase().startsWith('admin');
                localStorage.setItem('edrs_user', username);
                localStorage.setItem('edrs_isAdmin', isAdminUser);
            };
            
            this.logout = function() {
                currentUser = null;
                isAdminUser = false;
                localStorage.removeItem('edrs_user');
                localStorage.removeItem('edrs_isAdmin');
            };
            
            this.getCurrentUser = function() {
                if (!currentUser) {
                    currentUser = localStorage.getItem('edrs_user');
                    isAdminUser = localStorage.getItem('edrs_isAdmin') === 'true';
                }
                return currentUser;
            };
            
            this.isLoggedIn = function() {
                return this.getCurrentUser() !== null;
            };
            
            this.isAdmin = function() {
                if (!this.isLoggedIn()) return false;
                if (isAdminUser === false) {
                    isAdminUser = localStorage.getItem('edrs_isAdmin') === 'true';
                }
                return isAdminUser;
            };
        }]);

        // API Service
        app.service('ApiService', ['$http', 'API_CONFIG', function($http, API_CONFIG) {
            this.getInventory = function() {
                return $http.get(API_CONFIG.inventoryService + '/api/inventory');
            };
            
            this.getInventoryItem = function(id) {
                return $http.get(API_CONFIG.inventoryService + '/api/inventory/' + id);
            };
            
            this.getEffectiveAvailability = function(itemId, date) {
                var dateParam = encodeURIComponent(date);
                return $http.get(API_CONFIG.inventoryService + '/api/inventory/' + itemId + '/availability?date=' + dateParam);
            };
            
            this.addInventoryItem = function(item) {
                return $http.post(API_CONFIG.inventoryService + '/api/inventory', item);
            };
            
            this.getReservations = function(userId) {
                var url = API_CONFIG.reservationService + '/api/reservations';
                if (userId) {
                    url += '?userId=' + encodeURIComponent(userId);
                }
                return $http.get(url);
            };
            
            this.makeReservation = function(reservation) {
                return $http.post(API_CONFIG.reservationService + '/api/reservations', reservation);
            };
            
            this.cancelReservation = function(confirmationNumber) {
                return $http.post(API_CONFIG.reservationService + '/api/reservations/' + confirmationNumber + '/cancel');
            };
        }]);

        // Route Configuration
        app.config(['$routeProvider', '$locationProvider', function($routeProvider, $locationProvider) {
            // Use standard hash routing (no prefix)
            $locationProvider.hashPrefix('');
            $routeProvider
                .when('/login', {
                    templateUrl: 'views/login.html',
                    controller: 'LoginController',
                    controllerAs: 'vm',
                    viewName: 'login'
                })
                .when('/', {
                    redirectTo: '/reservations/new'
                })
                .when('/reservations/new', {
                    templateUrl: 'views/new-reservation.html',
                    controller: 'NewReservationController',
                    controllerAs: 'vm',
                    viewName: 'new-reservation',
                    resolve: {
                        auth: ['AuthService', '$location', function(AuthService, $location) {
                            if (!AuthService.isLoggedIn()) {
                                $location.path('/login');
                            }
                        }]
                    }
                })
                .when('/reservations', {
                    templateUrl: 'views/my-reservations.html',
                    controller: 'MyReservationsController',
                    controllerAs: 'vm',
                    viewName: 'my-reservations',
                    resolve: {
                        auth: ['AuthService', '$location', function(AuthService, $location) {
                            if (!AuthService.isLoggedIn()) {
                                $location.path('/login');
                            }
                        }]
                    }
                })
                .when('/inventory', {
                    templateUrl: 'views/inventory.html',
                    controller: 'InventoryController',
                    controllerAs: 'vm',
                    viewName: 'inventory',
                    resolve: {
                        auth: ['AuthService', '$location', function(AuthService, $location) {
                            if (!AuthService.isLoggedIn()) {
                                $location.path('/login');
                            }
                        }]
                    }
                })
                .when('/admin/reservations', {
                    templateUrl: 'views/admin-reservations.html',
                    controller: 'AdminReservationsController',
                    controllerAs: 'vm',
                    viewName: 'admin-reservations',
                    resolve: {
                        auth: ['AuthService', '$location', function(AuthService, $location) {
                            if (!AuthService.isLoggedIn() || !AuthService.isAdmin()) {
                                $location.path('/login');
                            }
                        }]
                    }
                })
                .when('/admin/inventory/add', {
                    templateUrl: 'views/admin-add-inventory.html',
                    controller: 'AdminAddInventoryController',
                    controllerAs: 'vm',
                    viewName: 'admin-add-inventory',
                    resolve: {
                        auth: ['AuthService', '$location', function(AuthService, $location) {
                            if (!AuthService.isLoggedIn() || !AuthService.isAdmin()) {
                                $location.path('/login');
                            }
                        }]
                    }
                })
                .otherwise({
                    redirectTo: '/login'
                });
        }]);

        // Login Controller
        app.controller('LoginController', ['$location', 'AuthService', function($location, AuthService) {
            var vm = this;
            vm.username = '';
            vm.error = '';
            
            if (AuthService.isLoggedIn()) {
                $location.path('/');
            }
            
            vm.login = function() {
                if (!vm.username || vm.username.trim() === '') {
                    vm.error = 'Please enter a username';
                    return;
                }
                
                // Stub authentication - just store the username
                AuthService.login(vm.username.trim());
                $location.path('/');
            };
        }]);

        // New Reservation Controller
        app.controller('NewReservationController', ['$scope', 'ApiService', 'AuthService', function($scope, ApiService, AuthService) {
            var vm = this;
            vm.inventoryItems = [];
            vm.selectedItems = {};
            vm.reservationDate = '';
            vm.loading = false;
            vm.submitting = false;
            vm.message = '';
            vm.messageType = '';
            
            // Clean up when controller is destroyed (navigating away)
            $scope.$on('$destroy', function() {
                vm.message = '';
                vm.messageType = '';
            });
            
            vm.loadInventory = function() {
                vm.loading = true;
                vm.message = ''; // Clear any previous errors
                ApiService.getInventory().then(
                    function(response) {
                        // Only update if still on this view
                        if (!$scope.$$destroyed) {
                            vm.inventoryItems = response.data;
                            vm.loading = false;
                            // If date is already selected, update effective availability
                            if (vm.reservationDate) {
                                vm.updateEffectiveAvailability();
                            }
                        }
                    },
                    function(error) {
                        // Only show error if still on this view
                        if (!$scope.$$destroyed) {
                            var errorMsg = 'Error loading inventory';
                            if (error.status === 0 || error.status === -1) {
                                errorMsg += ': Cannot connect to inventory service. Please ensure the service is running on http://localhost:8081';
                            } else {
                                errorMsg += ': ' + (error.data?.message || error.statusText || 'Unknown error');
                            }
                            vm.message = errorMsg;
                            vm.messageType = 'danger';
                            vm.loading = false;
                        }
                    }
                );
            };
            
            vm.addItem = function(itemId) {
                if (!itemId) {
                    console.log('addItem called with no itemId');
                    return;
                }
                
                console.log('addItem called with itemId:', itemId);
                
                // Find the item in the inventory list
                var item = null;
                for (var i = 0; i < vm.inventoryItems.length; i++) {
                    if (vm.inventoryItems[i].id === itemId) {
                        item = vm.inventoryItems[i];
                        break;
                    }
                }
                
                if (!item) {
                    console.warn('Item not found in inventory list:', itemId);
                    return;
                }
                
                if (vm.selectedItems[item.id]) {
                    console.log('Item already selected:', item.id);
                    return;
                }
                
                console.log('Adding item to selectedItems:', item.id, item.name);
                vm.selectedItems[item.id] = {
                    item: item,
                    quantity: 1
                };
                // Reset the dropdown selection
                vm.selectedItemId = '';
                
                // If date is set, fetch effective availability for this newly added item
                if (vm.reservationDate) {
                    var dateObj = new Date(vm.reservationDate);
                    var isoDate = dateObj.toISOString();
                    ApiService.getEffectiveAvailability(item.id, isoDate).then(
                        function(response) {
                            // Update the item in selectedItems
                            if (vm.selectedItems[item.id]) {
                                vm.selectedItems[item.id].item.effectiveAvailableQuantity = response.data.effectiveAvailableQuantity;
                            }
                            // Also update in the main inventory list
                            for (var j = 0; j < vm.inventoryItems.length; j++) {
                                if (vm.inventoryItems[j].id === item.id) {
                                    vm.inventoryItems[j].effectiveAvailableQuantity = response.data.effectiveAvailableQuantity;
                                    break;
                                }
                            }
                        },
                        function(error) {
                            console.warn('Could not get effective availability for ' + item.id, error);
                        }
                    );
                }
            };
            
            vm.removeItem = function(itemId) {
                delete vm.selectedItems[itemId];
            };
            
            vm.updateEffectiveAvailability = function() {
                if (!vm.reservationDate || vm.inventoryItems.length === 0) {
                    return;
                }
                
                // Format date as ISO string for the API
                var dateObj = new Date(vm.reservationDate);
                var isoDate = dateObj.toISOString();
                
                // Update effective availability for all items
                var updatePromises = [];
                for (var i = 0; i < vm.inventoryItems.length; i++) {
                    var item = vm.inventoryItems[i];
                    var itemId = item.id; // Capture itemId for closure
                    var promise = ApiService.getEffectiveAvailability(itemId, isoDate).then(
                        function(response) {
                            var responseItemId = response.data.itemId;
                            // Find and update the item
                            for (var j = 0; j < vm.inventoryItems.length; j++) {
                                if (vm.inventoryItems[j].id === responseItemId) {
                                    vm.inventoryItems[j].effectiveAvailableQuantity = response.data.effectiveAvailableQuantity;
                                    // Also update in selectedItems if present
                                    if (vm.selectedItems[responseItemId]) {
                                        vm.selectedItems[responseItemId].item.effectiveAvailableQuantity = response.data.effectiveAvailableQuantity;
                                    }
                                    break;
                                }
                            }
                        },
                        function(error) {
                            // Silently fail - keep base quantity
                            console.warn('Could not get effective availability for ' + itemId, error);
                        }
                    );
                    updatePromises.push(promise);
                }
            };
            
            // Watch for date changes and update effective availability
            $scope.$watch('vm.reservationDate', function(newDate, oldDate) {
                if (newDate && newDate !== oldDate) {
                    vm.updateEffectiveAvailability();
                }
            });
            
            // Helper function to get effective available quantity (or base if not loaded)
            vm.getAvailableQuantity = function(item) {
                if (item.effectiveAvailableQuantity !== undefined && item.effectiveAvailableQuantity !== null) {
                    return item.effectiveAvailableQuantity;
                }
                return item.availableQuantity || 0;
            };
            
            // Helper function to check if there are selected items
            vm.hasSelectedItems = function() {
                return Object.keys(vm.selectedItems).length > 0;
            };
            
            // Helper function to get selected items count
            vm.getSelectedItemsCount = function() {
                return Object.keys(vm.selectedItems).length;
            };
            
            vm.submitReservation = function() {
                if (Object.keys(vm.selectedItems).length === 0) {
                    vm.message = 'Please select at least one inventory item';
                    vm.messageType = 'warning';
                    return;
                }
                
                if (!vm.reservationDate) {
                    vm.message = 'Please select a reservation date';
                    vm.messageType = 'warning';
                    return;
                }
                
                var itemQuantities = {};
                for (var itemId in vm.selectedItems) {
                    var selected = vm.selectedItems[itemId];
                    if (selected.quantity > 0) {
                        itemQuantities[itemId] = selected.quantity;
                    }
                }
                
                if (Object.keys(itemQuantities).length === 0) {
                    vm.message = 'Please specify quantities for at least one item';
                    vm.messageType = 'warning';
                    return;
                }
                
                // Format date as ISO string
                var dateObj = new Date(vm.reservationDate);
                var isoDate = dateObj.toISOString();
                
                var reservation = {
                    userId: AuthService.getCurrentUser(),
                    inventoryItemQuantities: itemQuantities,
                    reservationDate: isoDate
                };
                
                vm.submitting = true;
                vm.message = '';
                
                ApiService.makeReservation(reservation).then(
                    function(response) {
                        if (!$scope.$$destroyed) {
                            vm.message = 'Reservation created successfully! Confirmation: ' + response.data.confirmationNumber;
                            vm.messageType = 'success';
                            vm.selectedItems = {};
                            vm.reservationDate = '';
                            vm.submitting = false;
                        }
                    },
                    function(error) {
                        if (!$scope.$$destroyed) {
                            vm.message = 'Error creating reservation: ' + (error.data?.message || error.statusText);
                            vm.messageType = 'danger';
                            vm.submitting = false;
                        }
                    }
                );
            };
            
            vm.loadInventory();
        }]);

        // My Reservations Controller
        app.controller('MyReservationsController', ['ApiService', 'AuthService', function(ApiService, AuthService) {
            var vm = this;
            vm.reservations = [];
            vm.inventoryItems = [];
            vm.loading = false;
            vm.error = '';
            
            vm.loadInventory = function() {
                ApiService.getInventory().then(
                    function(response) {
                        vm.inventoryItems = response.data;
                    },
                    function(error) {
                        // Silently fail - we'll just show item IDs if inventory can't be loaded
                        console.warn('Could not load inventory for item names:', error);
                    }
                );
            };
            
            vm.loadReservations = function() {
                vm.loading = true;
                var userId = AuthService.getCurrentUser();
                ApiService.getReservations(userId).then(
                    function(response) {
                        vm.reservations = response.data;
                        vm.loading = false;
                    },
                    function(error) {
                        vm.error = 'Error loading reservations: ' + (error.data?.message || error.statusText);
                        vm.loading = false;
                    }
                );
            };
            
            vm.cancelReservation = function(confirmationNumber) {
                if (!confirm('Are you sure you want to cancel this reservation?')) {
                    return;
                }
                
                ApiService.cancelReservation(confirmationNumber).then(
                    function() {
                        vm.loadReservations();
                    },
                    function(error) {
                        alert('Error cancelling reservation: ' + (error.data?.message || error.statusText));
                    }
                );
            };
            
            vm.formatDate = function(dateString) {
                if (!dateString) return '';
                try {
                    var date = new Date(dateString);
                    if (isNaN(date.getTime())) {
                        return dateString; // Return original string if invalid
                    }
                    return date.toLocaleString();
                } catch (e) {
                    return dateString; // Return original string on error
                }
            };
            
            vm.getItemName = function(itemId) {
                for (var i = 0; i < vm.inventoryItems.length; i++) {
                    if (vm.inventoryItems[i].id === itemId) {
                        return vm.inventoryItems[i].name;
                    }
                }
                return itemId; // Return ID if name not found
            };
            
            vm.loadInventory();
            vm.loadReservations();
        }]);

        // Inventory Controller
        app.controller('InventoryController', ['ApiService', '$scope', function(ApiService, $scope) {
            var vm = this;
            vm.inventoryItems = [];
            vm.loading = false;
            vm.error = '';
            
            vm.loadInventory = function() {
                vm.loading = true;
                ApiService.getInventory().then(
                    function(response) {
                        vm.inventoryItems = response.data;
                        // Fetch effective availability for all items (using current date/time)
                        vm.updateEffectiveAvailability();
                        vm.loading = false;
                    },
                    function(error) {
                        vm.error = 'Error loading inventory: ' + (error.data?.message || error.statusText);
                        vm.loading = false;
                    }
                );
            };
            
            vm.updateEffectiveAvailability = function() {
                if (vm.inventoryItems.length === 0) {
                    return;
                }
                
                // Use current date/time for availability check
                var now = new Date();
                var isoDate = now.toISOString();
                
                console.log('Updating effective availability for', vm.inventoryItems.length, 'items at', isoDate);
                
                // Update effective availability for all items
                for (var i = 0; i < vm.inventoryItems.length; i++) {
                    var item = vm.inventoryItems[i];
                    var itemId = item.id; // Capture itemId for closure
                    
                    (function(id) { // IIFE to properly capture itemId
                        ApiService.getEffectiveAvailability(id, isoDate).then(
                            function(response) {
                                var responseItemId = response.data.itemId;
                                console.log('Got effective availability for', responseItemId, ':', response.data.effectiveAvailableQuantity);
                                // Find and update the item
                                for (var j = 0; j < vm.inventoryItems.length; j++) {
                                    if (vm.inventoryItems[j].id === responseItemId) {
                                        vm.inventoryItems[j].effectiveAvailableQuantity = response.data.effectiveAvailableQuantity;
                                        break;
                                    }
                                }
                            },
                            function(error) {
                                // Log error but continue
                                console.warn('Could not get effective availability for ' + id, error);
                            }
                        );
                    })(itemId);
                }
            };
            
            // Helper function to get effective available quantity (or base if not loaded)
            vm.getAvailableQuantity = function(item) {
                if (item.effectiveAvailableQuantity !== undefined && item.effectiveAvailableQuantity !== null) {
                    return item.effectiveAvailableQuantity;
                }
                return item.availableQuantity || 0;
            };
            
            vm.loadInventory();
        }]);

        // Admin Reservations Controller
        app.controller('AdminReservationsController', ['ApiService', function(ApiService) {
            var vm = this;
            vm.reservations = [];
            vm.inventoryItems = [];
            vm.loading = false;
            vm.error = '';
            
            vm.loadInventory = function() {
                ApiService.getInventory().then(
                    function(response) {
                        vm.inventoryItems = response.data;
                    },
                    function(error) {
                        // Silently fail - we'll just show item IDs if inventory can't be loaded
                        console.warn('Could not load inventory for item names:', error);
                    }
                );
            };
            
            vm.loadReservations = function() {
                vm.loading = true;
                ApiService.getReservations().then(
                    function(response) {
                        vm.reservations = response.data;
                        vm.loading = false;
                    },
                    function(error) {
                        vm.error = 'Error loading reservations: ' + (error.data?.message || error.statusText);
                        vm.loading = false;
                    }
                );
            };
            
            vm.formatDate = function(dateString) {
                if (!dateString) return '';
                try {
                    var date = new Date(dateString);
                    if (isNaN(date.getTime())) {
                        return dateString; // Return original string if invalid
                    }
                    return date.toLocaleString();
                } catch (e) {
                    return dateString; // Return original string on error
                }
            };
            
            vm.getItemName = function(itemId) {
                for (var i = 0; i < vm.inventoryItems.length; i++) {
                    if (vm.inventoryItems[i].id === itemId) {
                        return vm.inventoryItems[i].name;
                    }
                }
                return itemId; // Return ID if name not found
            };
            
            vm.loadInventory();
            vm.loadReservations();
        }]);

        // Admin Add Inventory Controller
        app.controller('AdminAddInventoryController', ['ApiService', function(ApiService) {
            var vm = this;
            vm.item = {
                id: '',
                name: '',
                description: '',
                availableQuantity: 0,
                category: ''
            };
            vm.submitting = false;
            vm.message = '';
            vm.messageType = '';
            
            vm.submit = function() {
                if (!vm.item.id || !vm.item.name) {
                    vm.message = 'ID and Name are required';
                    vm.messageType = 'warning';
                    return;
                }
                
                if (vm.item.availableQuantity < 0) {
                    vm.message = 'Available quantity must be non-negative';
                    vm.messageType = 'warning';
                    return;
                }
                
                vm.submitting = true;
                vm.message = '';
                
                ApiService.addInventoryItem(vm.item).then(
                    function(response) {
                        vm.message = 'Inventory item added successfully!';
                        vm.messageType = 'success';
                        vm.item = {
                            id: '',
                            name: '',
                            description: '',
                            availableQuantity: 0,
                            category: ''
                        };
                        vm.submitting = false;
                    },
                    function(error) {
                        if (error.status === 409) {
                            vm.message = 'An item with this ID already exists';
                        } else {
                            vm.message = 'Error adding inventory item: ' + (error.data?.message || error.statusText);
                        }
                        vm.messageType = 'danger';
                        vm.submitting = false;
                    }
                );
            };
        }]);

        // Template definitions (inline)
        app.run(['$templateCache', function($templateCache) {
            // Login View
            $templateCache.put('views/login.html',
                '<div class="login-container">' +
                '  <div class="card">' +
                '    <div class="card-header text-center">' +
                '      <h4><i class="bi bi-box-arrow-in-right"></i> Login</h4>' +
                '    </div>' +
                '    <div class="card-body">' +
                '      <form ng-submit="vm.login()">' +
                '        <div class="mb-3">' +
                '          <label for="username" class="form-label">Username</label>' +
                '          <input type="text" class="form-control" id="username" ng-model="vm.username" placeholder="Enter username" autofocus>' +
                '        </div>' +
                '        <div class="alert alert-danger" ng-if="vm.error">{{vm.error}}</div>' +
                '        <div class="d-grid">' +
                '          <button type="submit" class="btn btn-primary btn-lg">Login</button>' +
                '        </div>' +
                '        <div class="mt-3 text-center text-muted">' +
                '          <small>Note: Authentication is stubbed. Any username will work.</small>' +
                '        </div>' +
                '      </form>' +
                '    </div>' +
                '  </div>' +
                '</div>'
            );

            // New Reservation View
            $templateCache.put('views/new-reservation.html',
                '<div class="row">' +
                '  <div class="col-lg-8 offset-lg-2">' +
                '    <div class="card">' +
                '      <div class="card-header">' +
                '        <h5 class="mb-0"><i class="bi bi-calendar-plus"></i> Make a Reservation</h5>' +
                '      </div>' +
                '      <div class="card-body">' +
                '        <div class="alert" ng-class="{\'alert-success\': vm.messageType === \'success\', \'alert-danger\': vm.messageType === \'danger\', \'alert-warning\': vm.messageType === \'warning\'}" ng-if="vm.message">' +
                '          {{vm.message}}' +
                '        </div>' +
                '        <form ng-submit="vm.submitReservation()">' +
                '          <div class="mb-3">' +
                '            <label for="reservationDate" class="form-label">Reservation Date</label>' +
                '            <input type="datetime-local" class="form-control" id="reservationDate" ng-model="vm.reservationDate" required>' +
                '            <small class="form-text text-muted">Select the date and time for your reservation</small>' +
                '          </div>' +
                '          <div class="mb-3">' +
                '            <label for="inventorySelect" class="form-label">Add Inventory Item</label>' +
                '            <select class="form-select" id="inventorySelect" ng-model="vm.selectedItemId" ng-options="item.id as (item.name + \' (\' + (vm.getAvailableQuantity(item) || item.availableQuantity) + \' available)\') for item in vm.inventoryItems" ng-change="vm.addItem(vm.selectedItemId)">' +
                '              <option value="">-- Select an item to add --</option>' +
                '            </select>' +
                '            <div ng-if="vm.loading" class="mt-2">' +
                '              <span class="spinner-border spinner-border-sm"></span> Loading inventory...' +
                '            </div>' +
                '          </div>' +
                '          <div class="mb-3">' +
                '            <label class="form-label"><strong>Selected Items for Reservation</strong>' +
                '              <span ng-if="vm.hasSelectedItems()" class="badge bg-primary ms-2">{{vm.getSelectedItemsCount()}} item(s)</span>' +
                '            </label>' +
                '            <div ng-if="!vm.hasSelectedItems()" class="alert alert-secondary">' +
                '              <i class="bi bi-info-circle"></i> No items selected yet. Choose an item from the dropdown above to add it here.' +
                '            </div>' +
                '            <div ng-if="vm.hasSelectedItems()" class="alert alert-warning mb-3">' +
                '              <i class="bi bi-exclamation-triangle"></i> <strong>Please specify the quantity</strong> you want to reserve for each item below.' +
                '            </div>' +
                '            <div ng-repeat="(itemId, selected) in vm.selectedItems" class="reservation-item mb-3 p-3 border rounded">' +
                '              <div class="row align-items-center">' +
                '                <div class="col-md-6">' +
                '                  <strong class="fs-5">{{selected.item.name}}</strong>' +
                '                  <div class="text-muted mt-1">{{selected.item.description || \'No description\'}}</div>' +
                '                  <div class="mt-2">' +
                '                    <span class="badge bg-info">Available: <strong>{{vm.getAvailableQuantity(selected.item)}}</strong></span>' +
                '                    <span ng-if="selected.item.effectiveAvailableQuantity !== undefined && selected.item.effectiveAvailableQuantity !== selected.item.availableQuantity" class="badge bg-warning text-dark ms-1">' +
                '                      ({{selected.item.availableQuantity}} total in inventory)' +
                '                    </span>' +
                '                  </div>' +
                '                </div>' +
                '                <div class="col-md-6">' +
                '                  <div class="d-flex align-items-center gap-3">' +
                '                    <div class="flex-grow-1">' +
                '                      <label class="form-label fw-bold mb-1">How many units to reserve?</label>' +
                '                      <input type="number" class="form-control form-control-lg" ng-model="selected.quantity" min="1" max="{{vm.getAvailableQuantity(selected.item)}}" placeholder="Enter quantity" required autofocus>' +
                '                      <small class="form-text text-muted">Maximum: {{vm.getAvailableQuantity(selected.item)}} units</small>' +
                '                    </div>' +
                '                    <button type="button" class="btn btn-outline-danger" ng-click="vm.removeItem(itemId)">' +
                '                      <i class="bi bi-x-circle"></i> Remove' +
                '                    </button>' +
                '                  </div>' +
                '                </div>' +
                '              </div>' +
                '            </div>' +
                '            <div class="alert alert-info mt-2" ng-if="vm.hasSelectedItems()">' +
                '              <small><i class="bi bi-info-circle"></i> You can add multiple items. Make sure to set the quantity for each item above before submitting.</small>' +
                '            </div>' +
                '          </div>' +
                '          <div class="d-grid gap-2 d-md-flex justify-content-md-end">' +
                '            <button type="submit" class="btn btn-primary" ng-disabled="vm.submitting">' +
                '              <span ng-if="vm.submitting" class="spinner-border spinner-border-sm me-2"></span>' +
                '              <i class="bi bi-check-circle" ng-if="!vm.submitting"></i> Submit Reservation' +
                '            </button>' +
                '          </div>' +
                '        </form>' +
                '      </div>' +
                '    </div>' +
                '  </div>' +
                '</div>'
            );

            // My Reservations View
            $templateCache.put('views/my-reservations.html',
                '<div class="row">' +
                '  <div class="col-12">' +
                '    <div class="card">' +
                '      <div class="card-header">' +
                '        <h5 class="mb-0"><i class="bi bi-list-ul"></i> My Reservations</h5>' +
                '      </div>' +
                '      <div class="card-body">' +
                '        <div ng-if="vm.loading" class="text-center py-4">' +
                '          <span class="spinner-border"></span> Loading...' +
                '        </div>' +
                '        <div ng-if="vm.error" class="alert alert-danger">{{vm.error}}</div>' +
                '        <div ng-if="!vm.loading && !vm.error && vm.reservations.length === 0" class="alert alert-info">' +
                '          You have no reservations yet.' +
                '        </div>' +
                '        <div class="table-responsive" ng-if="!vm.loading && vm.reservations.length > 0">' +
                '          <table class="table table-hover">' +
                '            <thead class="table-light">' +
                '              <tr>' +
                '                <th>Confirmation #</th>' +
                '                <th>Date</th>' +
                '                <th>Items</th>' +
                '                <th>Status</th>' +
                '                <th>Actions</th>' +
                '              </tr>' +
                '            </thead>' +
                '            <tbody>' +
                '              <tr ng-repeat="reservation in vm.reservations">' +
                '                <td><code>{{reservation.confirmationNumber}}</code></td>' +
                '                <td>{{vm.formatDate(reservation.reservationDate)}}</td>' +
                '                <td>' +
                '                  <div ng-repeat="(itemId, quantity) in reservation.inventoryItemQuantities">' +
                '                    <span class="badge bg-secondary" title="Item ID: {{itemId}}">{{vm.getItemName(itemId)}}: {{quantity}}</span>' +
                '                  </div>' +
                '                </td>' +
                '                <td>' +
                '                  <span class="badge status-badge" ng-class="{\'status-pending\': reservation.status === \'PENDING\', \'status-confirmed\': reservation.status === \'CONFIRMED\', \'status-cancelled\': reservation.status === \'CANCELLED\'}">' +
                '                    {{reservation.status}}' +
                '                  </span>' +
                '                </td>' +
                '                <td>' +
                '                  <button class="btn btn-sm btn-outline-danger" ng-if="reservation.status !== \'CANCELLED\'" ng-click="vm.cancelReservation(reservation.confirmationNumber)">' +
                '                    <i class="bi bi-x-circle"></i> Cancel' +
                '                  </button>' +
                '                </td>' +
                '              </tr>' +
                '            </tbody>' +
                '          </table>' +
                '        </div>' +
                '      </div>' +
                '    </div>' +
                '  </div>' +
                '</div>'
            );

            // Inventory View
            $templateCache.put('views/inventory.html',
                '<div class="row">' +
                '  <div class="col-12">' +
                '    <div class="card">' +
                '      <div class="card-header">' +
                '        <h5 class="mb-0"><i class="bi bi-box-seam"></i> All Inventory Items</h5>' +
                '      </div>' +
                '      <div class="card-body">' +
                '        <div ng-if="vm.loading" class="text-center py-4">' +
                '          <span class="spinner-border"></span> Loading...' +
                '        </div>' +
                '        <div ng-if="vm.error" class="alert alert-danger">{{vm.error}}</div>' +
                '        <div ng-if="!vm.loading && !vm.error && vm.inventoryItems.length === 0" class="alert alert-info">' +
                '          No inventory items found.' +
                '        </div>' +
                '        <div class="table-responsive" ng-if="!vm.loading && vm.inventoryItems.length > 0">' +
                '          <table class="table table-hover">' +
                '            <thead class="table-light">' +
                '              <tr>' +
                '                <th>ID</th>' +
                '                <th>Name</th>' +
                '                <th>Description</th>' +
                '                <th>Category</th>' +
                '                <th>Available Quantity</th>' +
                '              </tr>' +
                '            </thead>' +
                '            <tbody>' +
                '              <tr ng-repeat="item in vm.inventoryItems">' +
                '                <td><code>{{item.id}}</code></td>' +
                '                <td><strong>{{item.name}}</strong></td>' +
                '                <td>{{item.description || \'-\'}}</td>' +
                '                <td><span class="badge bg-info" ng-if="item.category">{{item.category}}</span></td>' +
                '                <td>' +
                '                  <span class="badge" ng-class="{\'bg-success\': vm.getAvailableQuantity(item) > 0, \'bg-warning\': vm.getAvailableQuantity(item) === 0}">' +
                '                    <strong>{{vm.getAvailableQuantity(item)}}</strong>' +
                '                    <span ng-if="item.effectiveAvailableQuantity !== undefined && item.effectiveAvailableQuantity !== item.availableQuantity" class="ms-1">' +
                '                      ({{item.availableQuantity}} total)' +
                '                    </span>' +
                '                  </span>' +
                '                  <small class="text-muted d-block mt-1" ng-if="item.effectiveAvailableQuantity !== undefined && item.effectiveAvailableQuantity !== item.availableQuantity">' +
                '                    Effective availability (accounts for reservations)' +
                '                  </small>' +
                '                </td>' +
                '              </tr>' +
                '            </tbody>' +
                '          </table>' +
                '        </div>' +
                '      </div>' +
                '    </div>' +
                '  </div>' +
                '</div>'
            );

            // Admin Reservations View
            $templateCache.put('views/admin-reservations.html',
                '<div class="row">' +
                '  <div class="col-12">' +
                '    <div class="card">' +
                '      <div class="card-header bg-warning text-dark">' +
                '        <h5 class="mb-0"><i class="bi bi-clipboard-data"></i> All Reservations (Admin)</h5>' +
                '      </div>' +
                '      <div class="card-body">' +
                '        <div ng-if="vm.loading" class="text-center py-4">' +
                '          <span class="spinner-border"></span> Loading...' +
                '        </div>' +
                '        <div ng-if="vm.error" class="alert alert-danger">{{vm.error}}</div>' +
                '        <div ng-if="!vm.loading && !vm.error && vm.reservations.length === 0" class="alert alert-info">' +
                '          No reservations found.' +
                '        </div>' +
                '        <div class="table-responsive" ng-if="!vm.loading && vm.reservations.length > 0">' +
                '          <table class="table table-hover">' +
                '            <thead class="table-light">' +
                '              <tr>' +
                '                <th>Confirmation #</th>' +
                '                <th>User</th>' +
                '                <th>Date</th>' +
                '                <th>Items</th>' +
                '                <th>Status</th>' +
                '              </tr>' +
                '            </thead>' +
                '            <tbody>' +
                '              <tr ng-repeat="reservation in vm.reservations">' +
                '                <td><code>{{reservation.confirmationNumber}}</code></td>' +
                '                <td><strong>{{reservation.userId}}</strong></td>' +
                '                <td>{{vm.formatDate(reservation.reservationDate)}}</td>' +
                '                <td>' +
                '                  <div ng-repeat="(itemId, quantity) in reservation.inventoryItemQuantities">' +
                '                    <span class="badge bg-secondary" title="Item ID: {{itemId}}">{{vm.getItemName(itemId)}}: {{quantity}}</span>' +
                '                  </div>' +
                '                </td>' +
                '                <td>' +
                '                  <span class="badge status-badge" ng-class="{\'status-pending\': reservation.status === \'PENDING\', \'status-confirmed\': reservation.status === \'CONFIRMED\', \'status-cancelled\': reservation.status === \'CANCELLED\'}">' +
                '                    {{reservation.status}}' +
                '                  </span>' +
                '                </td>' +
                '              </tr>' +
                '            </tbody>' +
                '          </table>' +
                '        </div>' +
                '      </div>' +
                '    </div>' +
                '  </div>' +
                '</div>'
            );

            // Admin Add Inventory View
            $templateCache.put('views/admin-add-inventory.html',
                '<div class="row">' +
                '  <div class="col-lg-6 offset-lg-3">' +
                '    <div class="card">' +
                '      <div class="card-header bg-warning text-dark">' +
                '        <h5 class="mb-0"><i class="bi bi-plus-square"></i> Add Inventory Item (Admin)</h5>' +
                '      </div>' +
                '      <div class="card-body">' +
                '        <div class="alert" ng-class="{\'alert-success\': vm.messageType === \'success\', \'alert-danger\': vm.messageType === \'danger\', \'alert-warning\': vm.messageType === \'warning\'}" ng-if="vm.message">' +
                '          {{vm.message}}' +
                '        </div>' +
                '        <form ng-submit="vm.submit()">' +
                '          <div class="mb-3">' +
                '            <label for="itemId" class="form-label">Item ID <span class="text-danger">*</span></label>' +
                '            <input type="text" class="form-control" id="itemId" ng-model="vm.item.id" required placeholder="e.g., item-001">' +
                '          </div>' +
                '          <div class="mb-3">' +
                '            <label for="itemName" class="form-label">Name <span class="text-danger">*</span></label>' +
                '            <input type="text" class="form-control" id="itemName" ng-model="vm.item.name" required placeholder="e.g., Laptop">' +
                '          </div>' +
                '          <div class="mb-3">' +
                '            <label for="itemDescription" class="form-label">Description</label>' +
                '            <textarea class="form-control" id="itemDescription" ng-model="vm.item.description" rows="3" placeholder="Optional description"></textarea>' +
                '          </div>' +
                '          <div class="mb-3">' +
                '            <label for="itemCategory" class="form-label">Category</label>' +
                '            <input type="text" class="form-control" id="itemCategory" ng-model="vm.item.category" placeholder="e.g., Electronics">' +
                '          </div>' +
                '          <div class="mb-3">' +
                '            <label for="itemQuantity" class="form-label">Available Quantity <span class="text-danger">*</span></label>' +
                '            <input type="number" class="form-control" id="itemQuantity" ng-model="vm.item.availableQuantity" min="0" required>' +
                '          </div>' +
                '          <div class="d-grid gap-2 d-md-flex justify-content-md-end">' +
                '            <button type="submit" class="btn btn-primary" ng-disabled="vm.submitting">' +
                '              <span ng-if="vm.submitting" class="spinner-border spinner-border-sm me-2"></span>' +
                '              <i class="bi bi-check-circle" ng-if="!vm.submitting"></i> Add Item' +
                '            </button>' +
                '          </div>' +
                '        </form>' +
                '      </div>' +
                '    </div>' +
                '  </div>' +
                '</div>'
            );
        }]);
    </script>
</body>
</html>